# -*- coding: utf-8 -*-
# Copyright 2020 Green Valley Belgium NV
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# @@license_version:1.7@@

from cStringIO import StringIO
from contextlib import closing
import itertools
import threading
import time

import mc_unittest
from mcfw.properties import unicode_property, long_property, unicode_list_property, bool_property, bool_list_property,\
    long_list_property, float_property, float_list_property, typed_property
from rogerthat.bizz.service import list_icon_library, get_icon_from_library
from rogerthat.utils import merge_transfer_object


class Dummy(object):

    def close(self):
        pass


dummy_lock = closing(Dummy())


class Test(mc_unittest.TestCase):

    def _testRecolor(self):

        def recolor_png_old(png_bytes, source_color, target_color, lock=dummy_lock):
            with lock:
                from rogerthat.utils import png

                def map_color(row, png_details):
                    i = iter(row)
                    if png_details['alpha']:
                        return itertools.chain(
                            *(target_color + b[3:] if b[:3] == source_color else b for b in itertools.izip(i, i, i, i)))
                    else:
                        return itertools.chain(
                            *(target_color if b == source_color else b for b in itertools.izip(i, i, i)))

                r = png.Reader(file=StringIO(str(png_bytes)))
                p = r.read()
                c = p[2]
                f = StringIO()
                w = png.Writer(**p[3])
                w.write(f, [map_color(row, p[3]) for row in c])
                return f.getvalue()

        def recolor_png_alt(png_bytes, source_color, target_color, lock=dummy_lock):
            with lock:
                from rogerthat.utils import png

                def map_color(row, png_details):
                    i = iter(row)
                    if png_details['alpha']:
                        return itertools.chain(
                            *(target_color + b[3:] if b[:3] == source_color else b for b in itertools.izip(i, i, i, i)))
                    else:
                        return itertools.chain(
                            *(target_color if b == source_color else b for b in itertools.izip(i, i, i)))

                r = png.Reader(bytes=png_bytes)
                p = r.read()
                c = p[2]
                f = StringIO()
                w = png.Writer(**p[3])
                w.write(f, (map_color(row, p[3]) for row in c))
                return f.getvalue()

        def timeit(stats, function, *args):
            start = time.time()
            result = function(*args)
            elapsed = time.time() - start
            fname = function.__name__
            if not fname in stats:
                stats[fname] = [elapsed]
            else:
                stats[fname].append(elapsed)
            return result

        source_color = (0, 0, 0)
        target_color = (12, 34, 255)

        stats = dict()
        start = time.time()
        for lmi in list_icon_library()[0:20]:
            png_bytes = get_icon_from_library(lmi.name)
            png_bytes1 = timeit(stats, recolor_png_old, png_bytes, source_color, target_color)
            png_bytes2 = timeit(stats, recolor_png_alt, png_bytes, source_color, target_color)
            self.assertEqual(png_bytes1, png_bytes2)
        end = time.time()

        for function, results in stats.iteritems():
            print function, len(results), min(results), max(results), sum(results) / len(results)
        print end - start
        print

        def run_in_thread(function, *args):
            def run():
                threading.currentThread().run_result = function(*args)

            t = threading.Thread(target=run)
            t.setDaemon(True)
            t.start()
            return t

        stats = dict()
        threads = list()
        start = time.time()
        for lmi in list_icon_library()[0:20]:
            png_bytes = get_icon_from_library(lmi.name)
            threads.append(run_in_thread(timeit, stats, recolor_png_old, png_bytes, source_color, target_color))
            threads.append(run_in_thread(timeit, stats, recolor_png_alt, png_bytes, source_color, target_color))

        while threads:
            t = threads.pop(0)
            t.join()
            png_bytes1 = t.run_result
            t = threads.pop(0)
            t.join()
            png_bytes2 = t.run_result
            self.assertEqual(png_bytes1, png_bytes2)
        end = time.time()

        for function, results in stats.iteritems():
            print function, len(results), min(results), max(results), sum(results) / len(results)
        print end - start
        print

        lock = threading.RLock()
        stats = dict()
        threads = list()
        start = time.time()
        for lmi in list_icon_library()[0:20]:
            png_bytes = get_icon_from_library(lmi.name)
            threads.append(run_in_thread(timeit, stats, recolor_png_old, png_bytes, source_color, target_color, lock))
            threads.append(run_in_thread(timeit, stats, recolor_png_alt, png_bytes, source_color, target_color, lock))

        while threads:
            t = threads.pop(0)
            t.join()
            png_bytes1 = t.run_result
            t = threads.pop(0)
            t.join()
            png_bytes2 = t.run_result
            self.assertEqual(png_bytes1, png_bytes2)
        end = time.time()

        for function, results in stats.iteritems():
            print function, len(results), min(results), max(results), sum(results) / len(results)
        print end - start
        print

    def _testStats(self):

        stats = {'recolor_png_alt': [
            0.5269999504089355,
            0.5079998970031738,
            0.46399998664855957,
            0.5470001697540283,
            0.5490000247955322,
            0.5259997844696045,
            0.5399999618530273,
            0.5190000534057617,
            0.43400001525878906,
            0.5469999313354492,
            0.5659999847412109,
            0.5209999084472656,
            0.6600000858306885,
            0.5839998722076416,
            0.5360000133514404,
            0.5230000019073486,
            0.5130000114440918,
            0.5130000114440918,
            0.5289998054504395,
            0.5130000114440918,
            0.5669999122619629,
            0.5419998168945312,
            0.5119998455047607,
            0.48600006103515625,
            0.5350000858306885,
            0.5239999294281006,
            0.5379998683929443,
            0.5379998683929443,
            0.5279998779296875,
            0.5449998378753662,
            0.562999963760376,
            0.627000093460083,
            0.5279998779296875,
            0.5440001487731934,
            0.5529999732971191,
            0.5509998798370361,
            0.5420000553131104,
            0.5420000553131104,
            0.5339999198913574,
            0.5940001010894775,
            0.5409998893737793,
            0.5230000019073486,
            0.5090000629425049,
            0.437000036239624,
            0.44299983978271484,
            0.5199999809265137,
            0.6530001163482666,
            0.5230000019073486,
            0.5789999961853027,
            0.5759999752044678,
            0.4909999370574951,
            0.5,
            0.39100003242492676,
            0.5360000133514404,
            0.5230000019073486,
            0.5310001373291016,
            0.4070000648498535,
            0.39499998092651367,
            0.5780000686645508,
            0.37800002098083496,
            0.4459998607635498,
            0.5140001773834229,
            0.5480000972747803,
            0.4930000305175781,
            0.5410001277923584,
            0.4869999885559082,
            0.5390000343322754,
            0.6030001640319824,
            0.4869999885559082,
            0.6349999904632568,
            0.501000165939331,
            0.5250000953674316,
            0.5399999618530273,
            0.5260000228881836,
            0.503000020980835,
            0.4630000591278076,
            0.4459998607635498,
            0.6180000305175781,
            0.5409998893737793,
            0.554999828338623,
            0.5659999847412109,
            0.5339999198913574,
            0.5829999446868896,
            0.5539999008178711,
            0.554999828338623,
            0.5279998779296875,
            0.5409998893737793,
            0.5199999809265137,
            0.4779999256134033,
            0.41700005531311035,
            0.49000000953674316,
            0.5610001087188721,
            0.4570000171661377,
            0.5239999294281006,
            0.5540001392364502,
            0.5310001373291016,
            0.5669999122619629,
            0.5410001277923584,
            0.5509998798370361,
            0.6099998950958252,
            0.5969998836517334,
            0.5619997978210449,
            0.5499999523162842,
            0.6059999465942383,
            0.5559999942779541,
            0.5179998874664307,
            0.5369999408721924,
            0.5240001678466797,
            0.4909999370574951,
            0.5219998359680176,
            0.48599982261657715,
            0.5390000343322754,
            0.5260000228881836,
            0.5440001487731934,
            0.5349998474121094,
            0.5180001258850098,
            0.503000020980835,
            0.5250000953674316,
            0.5309998989105225,
            0.5240001678466797,
            0.5550000667572021,
            0.557999849319458,
            0.5039999485015869,
            0.5880000591278076,
            0.5859999656677246,
            0.5390000343322754,
            0.6180000305175781,
            0.4509999752044678,
            0.5829999446868896,
            0.5830001831054688,
            0.5060000419616699,
            0.5230000019073486,
            0.4890000820159912,
            0.5310001373291016,
            0.5710000991821289,
            0.5460000038146973,
            0.5279998779296875,
            0.5150001049041748,
            0.5199999809265137,
            0.5160000324249268,
            0.5269999504089355,
            0.49000000953674316,
            0.5230000019073486,
            0.5240001678466797,
            0.5419998168945312,
            0.5380001068115234,
            0.5230000019073486,
            0.5989999771118164,
            0.5490000247955322,
            0.5349998474121094,
            0.5219998359680176,
            0.5099999904632568,
            0.5469999313354492,
            0.5090000629425049,
            0.5089998245239258,
            0.5130000114440918,
            0.5190000534057617,
            0.5339999198913574,
            0.5310001373291016,
            0.5220000743865967,
            0.5039999485015869,
            0.5690000057220459,
            0.5130000114440918,
            0.5269999504089355,
            0.562000036239624,
            0.564000129699707,
            0.5910000801086426,
            0.6060001850128174,
            0.5219998359680176,
            0.5729999542236328,
            0.5460000038146973,
            0.5510001182556152,
            0.5509998798370361,
            0.5309998989105225,
            0.560999870300293,
            0.5090000629425049,
            0.5339999198913574,
            0.5130000114440918,
            0.5610001087188721,
            0.5759999752044678,
            0.5479998588562012,
            0.5379998683929443,
            0.5160000324249268,
            0.5369999408721924,
            0.5179998874664307,
            0.5329999923706055,
            0.5510001182556152,
            0.5209999084472656,
            0.5149998664855957,
            0.5140001773834229,
            0.5290000438690186,
            0.5280001163482666,
            0.5240001678466797,
            0.5440001487731934,
            0.5389997959136963,
            0.5509998798370361,
            0.5239999294281006,
            0.5350000858306885,
            0.5260000228881836,
            0.5529999732971191,
            0.43400001525878906,
            0.5329999923706055,
            0.5789999961853027,
            0.5169999599456787,
            0.5460000038146973,
            0.5590000152587891,
            0.5219998359680176,
            0.5090000629425049,
            0.5350000858306885,
            0.5500001907348633,
            0.5089998245239258,
            0.4889998435974121,
            0.565000057220459,
            0.6080000400543213,
            0.5559999942779541,
            0.5320000648498535,
            0.5829999446868896,
            0.5080001354217529,
            0.5719997882843018,
            0.5499999523162842,
            0.5399999618530273,
            0.562999963760376,
            0.5390000343322754,
            0.5499999523162842,
            0.5509998798370361,
            0.5230000019073486,
            0.5190000534057617,
            0.5580000877380371,
            0.4660000801086426,
            0.4649999141693115,
            0.5199999809265137,
            0.5399999618530273,
            0.48399996757507324,
            0.5529999732971191,
            0.5490000247955322,
            0.5390000343322754,
            0.559999942779541,
            0.5329999923706055,
            0.5659999847412109,
            0.5200002193450928,
            0.5369999408721924,
            0.5780000686645508,
            0.5360000133514404,
            0.5350000858306885,
            0.5519998073577881,
            0.5,
            0.5460000038146973,
            0.5049998760223389,
            0.5659999847412109,
            0.5239999294281006,
            0.5250000953674316,
            0.5239999294281006,
            0.5149998664855957,
            0.5260000228881836,
            0.5320000648498535,
            0.560999870300293,
            0.5249998569488525,
            0.5239999294281006,
            0.5210001468658447,
            0.5440001487731934,
            0.5160000324249268,
            0.5169999599456787,
            0.5329999923706055,
            0.503000020980835,
            0.7589998245239258,
            0.8499999046325684,
            0.6010000705718994,
            0.8250000476837158,
            0.7269999980926514,
            0.5720000267028809,
            0.5299999713897705,
            0.5290000438690186,
            0.5369999408721924,
            0.556999921798706,
            0.5850000381469727,
            0.5600001811981201,
            0.47699999809265137,
            0.5419998168945312,
            0.5230000019073486,
            0.6040000915527344,
            0.5180001258850098,
            0.5090000629425049,
            0.6460001468658447,
            0.5440001487731934,
            0.6079998016357422,
            0.4939999580383301,
            0.5729999542236328,
            0.5470001697540283,
            0.5239999294281006,
            0.5269999504089355,
            0.5559999942779541,
            0.5390000343322754,
            0.5380001068115234,
            0.5469999313354492,
            0.5109999179840088,
            0.5690000057220459,
            0.6079998016357422,
            0.5369999408721924,
            0.5550000667572021,
            0.5669999122619629,
            0.5879998207092285,
            0.5219998359680176,
            0.4909999370574951,
            0.5539999008178711,
            0.5490000247955322,
            0.5940001010894775,
            0.5309998989105225,
            0.5360000133514404,
            0.5980000495910645,
            0.5290000438690186,
            0.5260000228881836,
            0.5390000343322754,
            0.45800018310546875,
            0.3619999885559082,
            0.5379998683929443,
            0.5829999446868896,
            0.6330001354217529,
            0.5310001373291016,
            0.5780000686645508,
            0.5499999523162842,
            0.9249999523162842,
            0.5239999294281006,
            0.5399999618530273,
            0.5350000858306885,
            0.5460000038146973,
            0.6909999847412109,
            0.6299998760223389,
            0.5269999504089355,
            0.7820000648498535,
            0.5860002040863037,
            0.5910000801086426,
            0.5769999027252197,
            0.6299998760223389,
            0.5480000972747803,
            0.5350000858306885,
            0.5519998073577881,
            0.5290000438690186,
            0.6189999580383301,
            0.6760001182556152,
            0.5539999008178711,
            0.8429999351501465,
            1.0129997730255127,
            0.9250001907348633,
            0.8229999542236328,
            0.8270001411437988,
            0.812000036239624,
            0.8220000267028809,
            0.9900000095367432,
            0.8320000171661377,
            0.8910000324249268,
            0.7929999828338623,
            0.996999979019165,
            0.9069998264312744,
            0.8139998912811279,
            0.8919999599456787,
            0.9719998836517334,
            0.6899998188018799,
            0.562999963760376,
            0.5799999237060547,
            0.6019999980926514,
            0.5839998722076416,
            0.6029999256134033,
            0.5610001087188721,
            0.5310001373291016,
            0.5420000553131104,
            0.5169999599456787,
            0.5690000057220459,
            0.5779998302459717,
            0.5360000133514404,
            0.5080001354217529,
            0.503000020980835,
            0.49199986457824707,
            0.5490000247955322,
            0.5639998912811279,
            0.5130000114440918,
            0.5920000076293945,
            0.5709998607635498,
            0.4590001106262207,
            0.5309998989105225,
            0.5360000133514404,
            0.562999963760376,
            0.5980000495910645,
            0.5590000152587891,
            0.5429999828338623,
            0.6699998378753662,
            0.6889998912811279,
            0.5359997749328613,
            0.5390000343322754,
            0.5369999408721924,
            0.5509998798370361,
            0.6189999580383301,
            0.5899999141693115,
            0.5850000381469727,
            0.9639999866485596,
            0.9080002307891846,
            0.5490000247955322,
            0.6720001697540283,
            0.5889999866485596,
            0.7229998111724854,
            0.5539999008178711,
            0.5479998588562012,
            0.5370001792907715,
            0.5850000381469727,
            0.5249998569488525,
            0.5310001373291016,
            0.6060001850128174,
            0.5690000057220459,
            0.5450000762939453,
            0.562000036239624,
            0.560999870300293,
            0.5479998588562012,
            0.5729999542236328,
            0.568000078201294,
            0.5710000991821289,
            0.5230000019073486,
            0.5160000324249268,
            0.5479998588562012,
            0.5450000762939453,
            0.5439999103546143,
            0.5460000038146973,
            0.5720000267028809,
            0.5510001182556152,
            0.5859999656677246,
            0.5940001010894775,
            0.5759999752044678,
            0.4909999370574951,
            0.7660000324249268,
            0.5980000495910645,
            0.6419999599456787,
            0.7330000400543213,
            0.5509998798370361,
            0.6630001068115234,
            1.005000114440918,
            0.5799999237060547,
            0.6340000629425049,
            0.7100000381469727,
            0.6469998359680176,
            0.804999828338623,
            0.5699999332427979,
            0.554999828338623,
            0.6540000438690186,
            0.562000036239624,
            0.5659999847412109,
            0.5850000381469727,
            0.5360000133514404,
            0.562000036239624,
            0.562000036239624,
            0.685999870300293,
            0.5199999809265137,
            0.5820000171661377,
            0.5910000801086426,
            0.5729999542236328,
            0.5399999618530273,
            0.5269999504089355,
            0.5419998168945312,
            0.5039999485015869,
            0.3920001983642578,
            0.5510001182556152,
            0.5500001907348633,
            0.5420000553131104,
            0.5380001068115234,
            0.5369999408721924,
            0.5250000953674316,
            0.6109998226165771,
            0.5360000133514404,
            0.5429999828338623,
            0.5899999141693115,
            0.5260000228881836,
            0.5439999103546143,
            0.5339999198913574,
            0.5570001602172852,
            0.5080001354217529,
            0.5550000667572021,
            0.5350000858306885,
            0.568000078201294,
            0.5250000953674316,
            0.5499999523162842,
            0.5910000801086426,
            0.5099999904632568,
            0.753000020980835,
            0.5559999942779541,
            0.7229998111724854,
            0.6160001754760742,
            0.5929999351501465,
            0.5119998455047607,
            0.5060000419616699,
            0.5099999904632568,
            0.5439999103546143,
            0.5369999408721924,
            0.6519999504089355,
            0.5399999618530273,
            0.5659999847412109,
            0.5380001068115234,
            0.5359997749328613,
            0.5180001258850098,
            0.5169999599456787,
            0.5360000133514404,
            0.5499999523162842,
            0.502000093460083,
            0.4760000705718994,
            0.47699999809265137,
            0.48000001907348633,
            0.46900010108947754,
            0.5080001354217529,
            0.4810001850128174,
            0.5250000953674316,
            0.5480000972747803,
            0.6640000343322754,
            0.5179998874664307,
            0.5380001068115234,
            0.497999906539917,
            0.5139999389648438,
            0.5220000743865967,
            0.5160000324249268,
            0.49900007247924805,
            0.4549999237060547,
            0.5469999313354492,
            0.5199999809265137,
            0.5099999904632568,
            0.4509999752044678,
            0.46899986267089844,
            0.5110001564025879,
            0.5049998760223389,
            0.5170001983642578,
            0.5080001354217529,
            0.4739999771118164,
            0.5089998245239258,
            0.5910000801086426,
            0.5980000495910645,
            0.5320000648498535,
            0.4869999885559082,
            0.5169999599456787,
            0.47699999809265137,
            0.5190000534057617,
            0.5139999389648438,
            0.503000020980835,
            0.5059998035430908,
            0.5710000991821289,
            0.502000093460083,
            0.5080001354217529,
            0.5099999904632568,
            0.5130000114440918,
            0.5490000247955322,
            0.5159997940063477,
            0.502000093460083,
            0.5339999198913574,
            0.6399998664855957,
            0.5180001258850098,
            0.5099999904632568,
            0.5340001583099365,
            0.46700000762939453,
            0.5109999179840088,
            0.5079998970031738,
            0.501000165939331,
            0.565000057220459,
            0.5199999809265137,
            0.5390000343322754,
            0.49199986457824707,
            0.49500012397766113,
            0.49000000953674316,
            0.5289998054504395,
            0.48400020599365234,
            0.504000186920166,
            0.5279998779296875,
            0.5499999523162842,
            0.4549999237060547,
            0.5130000114440918,
            0.4849998950958252,
            0.5970001220703125,
            0.5360000133514404,
            0.5,
            0.6189999580383301,
            0.8519999980926514,
            0.5190000534057617,
            0.6630001068115234,
            0.5759999752044678,
            0.5429999828338623,
            0.5480000972747803,
            0.5809998512268066,
            0.5090000629425049,
            0.5519998073577881,
            0.5180001258850098,
            0.5210001468658447,
            0.5389997959136963,
            0.5580000877380371,
            0.5169999599456787,
            0.4930000305175781,
            0.7619998455047607,
            0.5610001087188721,
            0.5379998683929443,
            0.5570001602172852,
            0.6429998874664307,
            0.5779998302459717,
            0.5690000057220459,
            0.5829999446868896,
            0.5160000324249268,
            0.5350000858306885,
            0.5249998569488525,
            0.5449998378753662,
            0.4509999752044678,
            0.45200014114379883],
            'recolor_png_old': [
                0.931999921798706,
                0.5460000038146973,
                0.49000000953674316,
                0.5839998722076416,
                0.5799999237060547,
                0.5540001392364502,
                0.5690000057220459,
                0.5499999523162842,
                0.5079998970031738,
                0.5590000152587891,
                0.6690001487731934,
                0.5529999732971191,
                0.7980000972747803,
                0.5590000152587891,
                0.7339999675750732,
                0.5429999828338623,
                0.5480000972747803,
                0.562000036239624,
                0.5420000553131104,
                0.5449998378753662,
                0.6070001125335693,
                0.5529999732971191,
                0.5930001735687256,
                0.5220000743865967,
                0.556999921798706,
                0.5630002021789551,
                0.5710000991821289,
                0.5659999847412109,
                0.562000036239624,
                0.5500001907348633,
                0.5929999351501465,
                0.5959999561309814,
                0.5750000476837158,
                0.5739998817443848,
                0.5810000896453857,
                0.5870001316070557,
                0.6029999256134033,
                0.5739998817443848,
                0.5550000667572021,
                0.6150000095367432,
                0.5630002021789551,
                0.5850000381469727,
                0.5419998168945312,
                0.4830000400543213,
                0.4680001735687256,
                0.5540001392364502,
                0.7039999961853027,
                0.5699999332427979,
                0.5550000667572021,
                0.5999999046325684,
                0.5770001411437988,
                0.5249998569488525,
                0.4140000343322754,
                0.5580000877380371,
                0.560999870300293,
                0.5709998607635498,
                0.434999942779541,
                0.4270000457763672,
                0.5909998416900635,
                0.4119999408721924,
                0.48600006103515625,
                0.5239999294281006,
                0.5889999866485596,
                0.5299999713897705,
                0.6150000095367432,
                0.5230000019073486,
                0.5520000457763672,
                0.621999979019165,
                0.5220000743865967,
                0.5460000038146973,
                0.6339998245239258,
                0.562999963760376,
                0.5590000152587891,
                0.6070001125335693,
                0.5409998893737793,
                0.47099995613098145,
                0.48400020599365234,
                0.6749999523162842,
                0.5880000591278076,
                0.565000057220459,
                0.6400001049041748,
                0.5590000152587891,
                0.6030001640319824,
                0.5800001621246338,
                0.5870001316070557,
                0.5780000686645508,
                0.5659999847412109,
                0.556999921798706,
                0.48200011253356934,
                0.43899989128112793,
                0.5230000019073486,
                0.5869998931884766,
                0.48600006103515625,
                0.5440001487731934,
                0.6480000019073486,
                0.5559999942779541,
                0.6230001449584961,
                0.5519998073577881,
                0.565000057220459,
                0.6119999885559082,
                0.6630001068115234,
                0.5820000171661377,
                0.5659999847412109,
                0.6030001640319824,
                0.5739998817443848,
                0.5580000877380371,
                0.564000129699707,
                0.557999849319458,
                0.5410001277923584,
                0.6170001029968262,
                0.503000020980835,
                0.568000078201294,
                0.556999921798706,
                0.554999828338623,
                0.5520000457763672,
                0.5469999313354492,
                0.5429999828338623,
                0.5520000457763672,
                0.5559999942779541,
                0.557999849319458,
                0.5940001010894775,
                0.564000129699707,
                0.5460000038146973,
                0.7200000286102295,
                0.6000001430511475,
                0.5989999771118164,
                0.627000093460083,
                0.4890000820159912,
                0.5899999141693115,
                0.5849997997283936,
                0.5220000743865967,
                0.562000036239624,
                0.5669999122619629,
                0.5679998397827148,
                0.5669999122619629,
                0.568000078201294,
                0.5380001068115234,
                0.5390000343322754,
                0.5450000762939453,
                0.5889999866485596,
                0.5469999313354492,
                0.5089998245239258,
                0.5490000247955322,
                0.565000057220459,
                0.5800001621246338,
                0.5529999732971191,
                0.562000036239624,
                0.5950000286102295,
                0.5920000076293945,
                0.5429999828338623,
                0.5559999942779541,
                0.5539999008178711,
                0.5659999847412109,
                0.5399999618530273,
                0.6059999465942383,
                0.556999921798706,
                0.5499999523162842,
                0.5720000267028809,
                0.5449998378753662,
                0.5429999828338623,
                0.5380001068115234,
                0.5880000591278076,
                0.5590000152587891,
                0.562999963760376,
                0.5679998397827148,
                0.6429998874664307,
                0.746999979019165,
                0.6159999370574951,
                0.5580000877380371,
                0.6099998950958252,
                0.6629998683929443,
                0.6129999160766602,
                0.5420000553131104,
                0.5469999313354492,
                0.5810000896453857,
                0.5460000038146973,
                0.565000057220459,
                0.5559999942779541,
                0.5559999942779541,
                0.7130000591278076,
                0.5559999942779541,
                0.6130001544952393,
                0.5559999942779541,
                0.5639998912811279,
                0.5520000457763672,
                0.5649998188018799,
                0.6269998550415039,
                0.5320000648498535,
                0.5390000343322754,
                0.559999942779541,
                0.5469999313354492,
                0.5450000762939453,
                0.5509998798370361,
                0.562999963760376,
                0.5710000991821289,
                0.564000129699707,
                0.562999963760376,
                0.5669999122619629,
                0.5350000858306885,
                0.568000078201294,
                0.4679999351501465,
                0.568000078201294,
                0.6710000038146973,
                0.5450000762939453,
                0.5900001525878906,
                0.6050000190734863,
                0.5370001792907715,
                0.5309998989105225,
                0.5639998912811279,
                0.560999870300293,
                0.5250000953674316,
                0.5190000534057617,
                0.5729999542236328,
                0.6180000305175781,
                0.6660001277923584,
                0.5789999961853027,
                0.5960001945495605,
                0.6110000610351562,
                0.5810000896453857,
                0.5720000267028809,
                0.5580000877380371,
                0.5520000457763672,
                0.557999849319458,
                0.5639998912811279,
                0.5590000152587891,
                0.554999828338623,
                0.5619997978210449,
                0.5899999141693115,
                0.49900007247924805,
                0.49900007247924805,
                0.565000057220459,
                0.5590000152587891,
                0.5120000839233398,
                0.5450000762939453,
                0.7400000095367432,
                0.562000036239624,
                0.5889999866485596,
                0.5710000991821289,
                0.5759999752044678,
                0.5469999313354492,
                0.562999963760376,
                0.557999849319458,
                0.5299999713897705,
                0.562999963760376,
                0.5540001392364502,
                0.5409998893737793,
                0.5979998111724854,
                0.5490000247955322,
                0.5820000171661377,
                0.5750000476837158,
                0.5999999046325684,
                0.5469999313354492,
                0.562000036239624,
                0.5360000133514404,
                0.5679998397827148,
                0.5920000076293945,
                0.5659999847412109,
                0.5279998779296875,
                0.5539999008178711,
                0.5559999942779541,
                0.5329999923706055,
                0.5510001182556152,
                0.5440001487731934,
                0.5279998779296875,
                0.7929999828338623,
                0.8650000095367432,
                0.6429998874664307,
                0.8310000896453857,
                0.6610000133514404,
                0.5929999351501465,
                0.5870001316070557,
                0.5420000553131104,
                0.5740001201629639,
                0.7240002155303955,
                0.5980000495910645,
                0.5679998397827148,
                0.500999927520752,
                0.5980000495910645,
                0.5249998569488525,
                0.5449998378753662,
                0.5690000057220459,
                0.5529999732971191,
                0.5889999866485596,
                0.5739998817443848,
                0.6630001068115234,
                0.5380001068115234,
                0.5360000133514404,
                0.5949997901916504,
                0.5740001201629639,
                0.5340001583099365,
                0.565000057220459,
                0.5799999237060547,
                0.556999921798706,
                0.5520000457763672,
                0.5559999942779541,
                0.6129999160766602,
                0.6170001029968262,
                0.5850000381469727,
                0.560999870300293,
                0.5820000171661377,
                0.5630002021789551,
                0.6180000305175781,
                0.5490000247955322,
                0.5720000267028809,
                0.5949997901916504,
                0.5869998931884766,
                0.5870001316070557,
                0.562999963760376,
                0.6459999084472656,
                0.5889999866485596,
                0.5610001087188721,
                0.560999870300293,
                0.49699997901916504,
                0.39499998092651367,
                0.5440001487731934,
                0.6040000915527344,
                0.6619999408721924,
                0.5559999942779541,
                0.6010000705718994,
                0.5870001316070557,
                0.7549998760223389,
                0.6200001239776611,
                0.5759999752044678,
                0.559999942779541,
                0.5730001926422119,
                0.5959999561309814,
                0.6670000553131104,
                0.5889999866485596,
                0.5659999847412109,
                0.6309998035430908,
                0.9179999828338623,
                0.6000001430511475,
                0.5920000076293945,
                0.6499998569488525,
                0.5799999237060547,
                0.5980000495910645,
                0.6340000629425049,
                0.5950000286102295,
                0.6039998531341553,
                0.6610000133514404,
                0.5690000057220459,
                1.0740001201629639,
                0.9849998950958252,
                1.0179998874664307,
                0.878000020980835,
                0.8619999885559082,
                0.8380000591278076,
                0.9570000171661377,
                0.8629999160766602,
                0.8849999904632568,
                0.7660000324249268,
                1.011000156402588,
                0.8440001010894775,
                0.9839999675750732,
                1.0179998874664307,
                0.9190001487731934,
                1.128000020980835,
                0.6449999809265137,
                0.56600022315979,
                0.94100022315979,
                0.6170001029968262,
                0.6110000610351562,
                0.5720000267028809,
                0.568000078201294,
                0.556999921798706,
                0.5360000133514404,
                0.5420000553131104,
                0.6130001544952393,
                0.5889999866485596,
                0.5529999732971191,
                0.5529999732971191,
                0.5900001525878906,
                0.5559999942779541,
                0.5740001201629639,
                0.5390000343322754,
                0.5750000476837158,
                0.5980000495910645,
                0.49499988555908203,
                0.5750000476837158,
                0.5510001182556152,
                0.5789999961853027,
                0.5610001087188721,
                0.7259998321533203,
                0.5690000057220459,
                0.6800000667572021,
                0.7950000762939453,
                0.6710000038146973,
                0.6159999370574951,
                0.625999927520752,
                0.5750000476837158,
                0.6159999370574951,
                0.6349999904632568,
                0.6649999618530273,
                0.6499998569488525,
                1.125999927520752,
                0.6180000305175781,
                0.7170000076293945,
                0.6070001125335693,
                0.6269998550415039,
                0.6100001335144043,
                0.6000001430511475,
                0.5739998817443848,
                0.6629998683929443,
                0.556999921798706,
                0.5709998607635498,
                0.5829999446868896,
                0.5929999351501465,
                0.6410000324249268,
                0.6400001049041748,
                0.687999963760376,
                0.5789999961853027,
                0.5810000896453857,
                0.5739998817443848,
                0.5950000286102295,
                0.5580000877380371,
                0.5460000038146973,
                0.5970001220703125,
                0.5779998302459717,
                0.6570000648498535,
                0.5480000972747803,
                0.6030001640319824,
                0.6429998874664307,
                0.5750000476837158,
                0.6200001239776611,
                0.6359999179840088,
                0.5889999866485596,
                0.5899999141693115,
                0.6459999084472656,
                0.7730000019073486,
                0.6740000247955322,
                0.6189999580383301,
                0.7829999923706055,
                0.5859999656677246,
                0.875999927520752,
                0.6940000057220459,
                0.7439999580383301,
                0.9520001411437988,
                0.6520001888275146,
                0.687000036239624,
                0.6570000648498535,
                0.6150000095367432,
                0.6330001354217529,
                0.6039998531341553,
                0.6899998188018799,
                0.7059998512268066,
                0.6170001029968262,
                0.5729999542236328,
                0.7390000820159912,
                0.5410001277923584,
                0.5749998092651367,
                0.684999942779541,
                0.6110000610351562,
                0.6109998226165771,
                0.5760002136230469,
                0.5720000267028809,
                0.5120000839233398,
                0.4029998779296875,
                0.6089999675750732,
                0.5749998092651367,
                0.5669999122619629,
                0.5669999122619629,
                0.5590000152587891,
                0.6129999160766602,
                0.6490001678466797,
                0.5759999752044678,
                0.5659999847412109,
                0.5900001525878906,
                0.5529999732971191,
                0.5810000896453857,
                0.559999942779541,
                0.5690000057220459,
                0.5429999828338623,
                0.5940001010894775,
                0.5490000247955322,
                0.6150000095367432,
                0.5749998092651367,
                0.5540001392364502,
                0.6050000190734863,
                0.6099998950958252,
                0.815000057220459,
                0.6469998359680176,
                0.7260000705718994,
                0.6699998378753662,
                0.5950000286102295,
                0.6349999904632568,
                0.5590000152587891,
                0.5450000762939453,
                0.5759999752044678,
                0.6040000915527344,
                0.5539999008178711,
                0.6369998455047607,
                0.570000171661377,
                0.5999999046325684,
                0.5530002117156982,
                0.5469999313354492,
                0.5329999923706055,
                0.5320000648498535,
                0.5550000667572021,
                0.5499999523162842,
                0.5339999198913574,
                0.5720000267028809,
                0.5109999179840088,
                0.5160000324249268,
                0.5460000038146973,
                0.5149998664855957,
                0.5499999523162842,
                0.5659999847412109,
                0.684999942779541,
                0.5480000972747803,
                0.560999870300293,
                0.5460000038146973,
                0.5360000133514404,
                0.5580000877380371,
                0.5529999732971191,
                0.5299999713897705,
                0.4869999885559082,
                0.5550000667572021,
                0.5399999618530273,
                0.5529999732971191,
                0.4850001335144043,
                0.567000150680542,
                0.5369999408721924,
                0.5390000343322754,
                0.5460000038146973,
                0.5309998989105225,
                0.49500012397766113,
                0.5329999923706055,
                0.6169998645782471,
                0.564000129699707,
                0.562000036239624,
                0.5239999294281006,
                0.5499999523162842,
                0.5120000839233398,
                0.5490000247955322,
                0.5470001697540283,
                0.5450000762939453,
                0.5310001373291016,
                0.6559998989105225,
                0.5309998989105225,
                0.5920000076293945,
                0.5369999408721924,
                0.5499999523162842,
                0.5810000896453857,
                0.5470001697540283,
                0.5399999618530273,
                0.5699999332427979,
                0.6710000038146973,
                0.5469999313354492,
                0.5329999923706055,
                0.5590000152587891,
                0.49200010299682617,
                0.5260000228881836,
                0.5250000953674316,
                0.5399999618530273,
                0.5399999618530273,
                0.5559999942779541,
                0.6670000553131104,
                0.5180001258850098,
                0.5209999084472656,
                0.5759999752044678,
                0.5500001907348633,
                0.5130000114440918,
                0.5279998779296875,
                0.5450000762939453,
                0.5290000438690186,
                0.4830000400543213,
                0.5440001487731934,
                0.5180001258850098,
                0.5529999732971191,
                0.6080000400543213,
                0.5269999504089355,
                0.5630002021789551,
                0.5740001201629639,
                0.8799998760223389,
                0.6659998893737793,
                0.5690000057220459,
                0.5669999122619629,
                0.557999849319458,
                0.6130001544952393,
                0.6329998970031738,
                0.5600001811981201,
                0.5709998607635498,
                0.5429999828338623,
                0.5570001602172852,
                0.5989999771118164,
                0.5520000457763672,
                0.5279998779296875,
                0.5840001106262207,
                0.5889999866485596,
                0.5420000553131104,
                0.5709998607635498,
                0.567000150680542,
                0.6480000019073486,
                0.6059999465942383,
                0.5759999752044678,
                0.5559999942779541,
                0.5690000057220459,
                0.5499999523162842,
                0.5420000553131104,
                0.497999906539917,
                0.5369999408721924]}

        for function, results in stats.iteritems():
            print function, len(results), min(results), max(results), sum(results) / len(results)


class Class1(object):
    my_unicode = unicode_property('my_unicode')
    my_unicode_list = unicode_list_property('my_unicode_list')
    my_bool = bool_property('my_bool')
    my_bool_list = bool_list_property('my_bool_list')
    my_long = long_property('my_long')
    my_long_list = long_list_property('my_long_list')
    my_float = float_property('my_float')
    my_float_list = float_list_property('my_float_list')


class Class2(object):
    my_obj = typed_property('my_obj', Class1, False)
    my_obj_list = typed_property('my_obj_list', Class1, True)


class TestMerge(mc_unittest.TestCase):

    def assertClass1Equal(self, src, dst):
        self.assertEqual(src.my_unicode, dst.my_unicode)
        self.assertListEqual(src.my_unicode_list, dst.my_unicode_list)
        self.assertEqual(src.my_bool, dst.my_bool)
        self.assertListEqual(src.my_bool_list, dst.my_bool_list)
        self.assertEqual(src.my_long, dst.my_long)
        self.assertListEqual(src.my_long_list, dst.my_long_list)
        self.assertEqual(src.my_float, dst.my_float)
        self.assertListEqual(src.my_float_list, dst.my_float_list)

    def test_merge_transfer_object(self):
        obj1 = Class1()
        obj1.my_bool = False
        obj1.my_bool_list = [True, False, True, False, True]
        obj1.my_float = 0.12
        obj1.my_float_list = [0.12, 3.14, 6.66]
        obj1.my_long = 12
        obj1.my_long_list = [12, 314, 666]
        obj1.my_unicode = u'a random unicode'
        obj1.my_unicode_list = [u'not so random 1', u'not so random 2', u'not so random 3']

        obj2 = Class1()
        obj2.my_bool = True
        obj2.my_bool_list = [False, False, False, False, True]
        obj2.my_float = 21.54687
        obj2.my_float_list = [12.463, 35687.54, 12.68354]
        obj2.my_long = 538735
        obj2.my_long_list = [67354, 6678354, 123684876]
        obj2.my_unicode = u'fhgdfgsd'
        obj2.my_unicode_list = [u'xcvhsjdfgd', u'lyuyuil', u'sdfaehftj']

        obj3 = Class1()
        obj3.my_bool = False
        obj3.my_bool_list = [True, True, True, False, True]
        obj3.my_float = 45.72
        obj3.my_float_list = [32.687, 5.2314, 65.687987]
        obj3.my_long = 89731687
        obj3.my_long_list = [321, 654, 98321]
        obj3.my_unicode = u'liusdkhjsdg'
        obj3.my_unicode_list = [u'sadlgkhaef', u'v`d;iogr', u'afskhjlasg']

        src = Class2()
        src.my_obj = obj1
        src.my_obj_list = [obj2, obj3]

        dst = merge_transfer_object(src, Class2())
        self.assertClass1Equal(src.my_obj, dst.my_obj)
        self.assertClass1Equal(src.my_obj_list[0], dst.my_obj_list[0])
        self.assertClass1Equal(src.my_obj_list[1], dst.my_obj_list[1])
