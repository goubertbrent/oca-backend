<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Rogerthat Message Flow Designer</title>
    <link rel="icon" href="../favicon.png" type="image/png" />
  <link rel="SHORTCUT ICON" href="../favicon.png" type="image/png" />

<!-- jQuery -->
<link rel="stylesheet" href="/static/css/start-1.8.9/jquery-ui-1.8.9.custom.css" />
<link rel="stylesheet" href="/static/jquery.css" type="text/css" media="screen, projection" />


<!-- YUI -->
<link rel="stylesheet" type="text/css" href="lib/yui/reset-fonts-grids/reset-fonts-grids.css" />
<link rel="stylesheet" type="text/css" href="lib/yui/assets/skins/sam/skin.css" />

<!-- InputEx CSS -->
<link type='text/css' rel='stylesheet' href='lib/inputex/build/inputex-min.css' />

<!-- YUI-accordion CSS -->
<link rel="stylesheet" type="text/css" href="lib/accordionview/assets/skins/sam/accordionview.css" />

<!-- WireIt CSS -->
<link rel="stylesheet" type="text/css" href="css/WireIt.css" />
<link rel="stylesheet" type="text/css" href="css/WireItEditor.css" />
<link rel="stylesheet" type="text/css" href="css/Rogerthat.css" />



<style>
div.WireIt-Container {
    width: 350px; /* Prevent the modules from scratching on the right */
}

div.WireIt-InOutContainer {
    width: 150px;
}

div.WireIt-InputExTerminal {
    float: left;
    width: 21px;
    height: 21px;
    position: relative;
}
div.WireIt-InputExTerminal div.WireIt-Terminal {
    top: -3px;
    left: -7px;
}
div.inputEx-Group div.inputEx-label {
    width:100px;
}

div.WireIt-ImageContainer {
    width: auto;
}

div.Bubble div.body {
    width: 70px;
    height: 45px;
    opacity: 0.8;
    cursor: move;
}

.WiringEditor-module span {
    position: relative;
    top: -3px;
}

textarea {
    resize: none;
}

#snippetsDialog label {
    width: 100px;
    display: block;
    float: left;
    text-align: right;
    margin-right: 2px;
}

#snippetsDialog select {
    width: 553px;
    display: block;
    margin-bottom: 5px;
}

#snippetsDialog input {
    width: 550px;
    display: block;
    margin-bottom: 5px;
}

</style>

<!-- YUI -->
<script type="text/javascript" src="lib/yui/utilities/utilities.js"></script>
<script type="text/javascript" src="lib/yui/resize/resize-min.js"></script>
<script type="text/javascript" src="lib/yui/layout/layout-min.js"></script>
<script type="text/javascript" src="lib/yui/container/container-min.js"></script>
<script type="text/javascript" src="lib/yui/json/json-min.js"></script>
<script type="text/javascript" src="lib/yui/button/button-min.js"></script>
<script type="text/javascript" src="lib/yui/tabview/tabview-min.js"></script>

<!-- InputEx with wirable options (WirableField-beta) -->
<script src="lib/inputex/build/inputex-min.js"  type='text/javascript'></script>
<script type="text/javascript" src="js/util/inputex/WirableField-beta.js"></script>

<!-- YUI-Accordion -->
<script src="lib/accordionview/accordionview-min.js"  type='text/javascript'></script>

<script type="text/javascript" src="lib/canvas.text.js"></script>

<!-- WireIt -->
<!--[if IE]><script type="text/javascript" src="lib/excanvas.js"></script><![endif]-->
<script type="text/javascript" src="js/WireIt.js"></script>
<script type="text/javascript" src="js/CanvasElement.js"></script>
<script type="text/javascript" src="js/Wire.js"></script>
<script type="text/javascript" src="js/Terminal.js"></script>
<script type="text/javascript" src="js/util/DD.js"></script>
<script type="text/javascript" src="js/util/DDResize.js"></script>
<script type="text/javascript" src="js/Container.js"></script>
<script type="text/javascript" src="js/Layer.js"></script>
<script type="text/javascript" src="js/Layout.js"></script>
<script type="text/javascript" src="js/util/inputex/FormContainer-beta.js"></script>
<script type="text/javascript" src="js/LayerMap.js"></script>
<script type="text/javascript" src="js/WiringEditor.js"></script>
<script type="text/javascript" src="js/ImageContainer.js"></script>
<script type="text/javascript" src="js/InOutContainer.js"></script>
<script type="text/javascript" src="js/adapters/ajax.js"></script>

<script type="text/javascript">

var messageflow_keys = [];
var messageflow_names = [];

var sub_messageflow_keys = [];
var sub_messageflow_names = [];

var DEFAULT_SERVICE_IDENTITY = "+default+";
var mfLanguage;

</script>

<!-- JQUERY -->
<!--[if IE]><script type="text/javascript" src="/static/js/json2.js"></script><![endif]-->
<script src="/static/js/jquery-1.6.1.min.js" type="text/javascript"></script>
<script src="/static/js/jquery-ui-1.8.13.custom.min.js" type="text/javascript"></script>

<!-- ROGERTHAT -->
<script type="text/javascript" src="WiringEditor/validation_snippets.js"></script>
<script type="text/javascript" src="WiringEditor/mfd.js"></script>
<script type="text/javascript" src="/static/js/stacktrace.js"></script>
<script type="text/javascript" src="/static/js/mc.js"></script>


<style>
/* Comment Module */
div.WireIt-Container.WiringEditor-module-comment { width: 200px; }
div.WireIt-Container.WiringEditor-module-comment div.body { background-color: #EEEE66; }
div.WireIt-Container.WiringEditor-module-comment div.body textarea { background-color: transparent; font-weight: bold; border: 0; }
</style>

<script type="text/javascript">

$(window).load(function () {
    $("#processingBar").progressbar({value:100});
    mctracker._processingDialog = $("#processingDialog").dialog({
        autoOpen: false,
        modal: true,
        dragable: false,
        resizable: false,
        title: 'Processing ...',
        width: 200,
        height: 75
    });
});


loadMessageFlows();

getBrandings(function (brandings) {
    var brandingNames = ['[no branding]'].concat(brandings.map(function (branding) {
        return branding.description + ' (' + mctracker.formatDate(branding.timestamp, true, false) + ')';
    }));
    var brandingKeys = [''].concat(brandings.map(function (branding) {
        return branding.id;
    }));
    getDefaultIdentity(function (defaultIdentity) {
        var descriptionBranding = defaultIdentity.description_branding;
        initDesigner(brandingKeys, brandingNames, descriptionBranding);
    });
});


// InputEx needs a correct path to this image
inputEx.spacerUrl = "/static/mfd/lib/inputex/images/space.gif";

function getBrandings(callback) {
    mctracker.call({
        url: '/mobi/rest/branding/list',
        hideProcessing: true,
        type: 'GET',
        success: function (data, textStatus, XMLHttpRequest) {
            callback(data);
        },
        error: function (data, textStatus, XMLHttpRequest) {
            mctracker.alert('Could not load available brandings from server.');
        }
    });
}

function getDefaultIdentity(callback) {
    mctracker.call({
        url: '/mobi/rest/service/identity',
        hideProcessing: true,
        data: {
            identifier: DEFAULT_SERVICE_IDENTITY
        },
        success: function (data) {
            callback(data);
        }
    });
}


function loadMessageFlows() {
    $.ajax({
        url: '/mobi/rest/mfd/list',
        data: {
            with_design_only: true  // TODO: remove data to get all flows
        },
        type: 'GET',
        async: false,
        success: function  (data, textStatus, XMLHttpRequest) {
            while (messageflow_keys.length)
                messageflow_keys.pop();
            while (messageflow_names.length)
                messageflow_names.pop();
            while (sub_messageflow_keys.length)
                sub_messageflow_keys.pop();
            while (sub_messageflow_names.length)
                sub_messageflow_names.pop();
            messageflow_keys.push('');
            messageflow_names.push('Please select a message flow');
            sub_messageflow_keys.push('');
            sub_messageflow_names.push('Please select a message flow');
            $.each(data.message_flows, function(i, mfd) {
                if (!mfd.no_definition) {
                    messageflow_keys.push(mfd.id);
                    messageflow_names.push(mfd.name);
                }
                sub_messageflow_keys.push(mfd.id);
                sub_messageflow_names.push(mfd.name);
            });
        },
        error: function (data, textStatus, XMLHttpRequest) {
            throw "Could not load available message flows from server.";
        }
    });
}

function initDesigner(brandingKeys, brandingNames, descriptionBranding) {
    try {
        mfLanguage = initMfd(brandingKeys, brandingNames, descriptionBranding);
        WireIt.WiringEditor.adapters.Ajax.config = {
            saveWiring: {
                method: 'POST',
                url: '/mobi/rest/services/mfd/save'
            },
            deleteWiring: {
                method: 'POST',
                url: '/mobi/rest/services/mfd/delete'
            },
            listWirings: {
                method: 'GET',
                url: '/mobi/rest/services/mfd/load'
            }
        };

        WireIt.WiringEditor.adapters.Ajax.init = function () {
            YAHOO.util.Connect.setDefaultPostHeader('application/x-www-form-urlencoded');
        };
        editor = new WireIt.WiringEditor(mfLanguage);

        // Open the infos panel
        editor.accordionView.openPanel(1);
        editor.accordionView.openPanel(2);
    }
    catch (ex) {
        console.error(ex);
    }
}

</script>

<!-- CodeMirror imports -->
<link rel="stylesheet" href="CodeMirror/lib/codemirror.css">
<script src="CodeMirror/lib/codemirror.js"></script>
<script src="CodeMirror/mode/python/python.js"></script>
<script src="CodeMirror/mode/javascript/javascript.js"></script>
<link rel="stylesheet" href="CodeMirror/theme/default.css">
</head>

<body class="yui-skin-sam">

    <div id="top">
        <div id="toolbar"></div>
    </div>

    <div id="left">
      <ul id="accordionView">
        <li>
            <h2>Properties</h2>
            <div>
                <div id="propertiesForm"></div>
            </div>
        </li>
        <li>
            <h2>Modules</h2>
            <div>
                <div id="modules"></div>
            </div>
        </li>
        <li>
            <h2>Minimap</h2>
            <div>
                <div id="layerMap"></div>
            </div>
        </li>
      </ul>
    </div>

    <div id="center">
    </div>

    <div id="processingDialog">
        <style>
        .ui-progressbar-value { background-image: url(/static/images/pbar-ani.gif); }
        </style>
        <div id="processingBar"></div>
    </div>

    <div id="snippetsDialog" style="display: none; text-align: left">
        <div>
            <label>Snippet: </label>
            <select id="snippet"></select>
        </div>

        <div id="snippet_placeholders"></div>

        <div style="background-color: #fff; text-align: left;">
            <textarea id="snippet_code" style="height: 80%; width: 98%;"></textarea>
        </div>
    </div>
</body>
</html>
